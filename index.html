<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Booking Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Simple transition for page content */
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .page-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            animation: fadeIn 0.2s ease;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            animation: modalIn 0.3s ease;
        }
        .modal.active, .modal-backdrop.active {
            display: block;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translate(-50%, -45%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
    </style>
</head>
<body class="h-full flex antialiased font-sans text-slate-800">

    <!-- Sidebar Navigation -->
    <nav class="w-20 md:w-64 bg-white shadow-lg flex flex-col flex-shrink-0">
        <div class="h-20 flex items-center justify-center md:justify-start md:pl-6 border-b border-slate-200">
            <span class="text-2xl text-indigo-600" title="Booking System">üíª</span>
            <span class="hidden md:block ml-3 text-xl font-bold text-indigo-600">Booking System</span>
        </div>
        <ul class="flex-grow py-6 space-y-2">
            <li>
                <a href="#dashboard" class="nav-link active-nav" data-page="dashboard">
                    <span class="text-2xl">üìä</span>
                    <span class="hidden md:block ml-4">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#bookings" class="nav-link" data-page="bookings">
                    <span class="text-2xl">üìÖ</span>
                    <span class="hidden md:block ml-4">Bookings</span>
                </a>
            </li>
            <li>
                <a href="#logs" class="nav-link" data-page="logs">
                    <span class="text-2xl">üìú</span>
                    <span class="hidden md:block ml-4">Activity Logs</span>
                </a>
            </li>
        </ul>
        <div class="p-4 border-t border-slate-200">
            <div class="p-3 bg-slate-100 rounded-lg">
                <span class="text-xs font-medium text-slate-500">Local User ID</span>
                <p id="userIdDisplay" class="text-xs text-slate-700 break-all" title="Current Local User ID">Loading...</p>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 h-full overflow-y-auto bg-slate-100">
        <div class="p-4 md:p-8">

            <!-- Page: Dashboard -->
            <div id="page-dashboard" class="page-content active">
                <h1 class="text-3xl font-bold mb-6 text-slate-900">Overview</h1>
                
                <h2 class="text-lg font-semibold text-slate-600 mb-4 flex items-center">
                    <span class="mr-2">üñ•Ô∏è</span> Computers
                </h2>
                <div id="pc-stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- PC Stats generated by JS -->
                </div>

                <h2 class="text-lg font-semibold text-slate-600 mb-4 flex items-center">
                    <span class="mr-2">üíª</span> Laptops
                </h2>
                <div id="laptop-stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Laptop Stats generated by JS -->
                </div>

                <div class="mt-8 bg-white rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold p-6 border-b border-slate-100">Recent Booking Activity</h2>
                    <div class="p-6">
                        <ul id="recent-activity-list" class="space-y-4">
                            <li class="text-center text-slate-400 py-4 italic">No recent activity.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Page: Bookings -->
            <div id="page-bookings" class="page-content">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <h1 class="text-3xl font-bold text-slate-900">Schedule</h1>
                    <button id="openBookingModalBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md transition duration-200 flex items-center">
                        <span class="mr-2">‚ûï</span> New Booking
                    </button>
                </div>
                
                <div class="flex items-center justify-center space-x-6 mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <button id="prevDayBtn" class="p-2 rounded-full hover:bg-slate-100 transition border border-slate-200">
                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h2 id="bookingDateDisplay" class="text-xl font-bold w-64 text-center text-indigo-900"></h2>
                    <button id="nextDayBtn" class="p-2 rounded-full hover:bg-slate-100 transition border border-slate-200">
                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <!-- Delegate Listener Attached to this Container -->
                <div id="schedules-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                    <!-- Resource schedules generated by JS -->
                </div>
            </div>

            <!-- Page: User Logs -->
            <div id="page-logs" class="page-content">
                <h1 class="text-3xl font-bold mb-6 text-slate-900">Audit Logs</h1>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="table-header">Timestamp</th>
                                <th class="table-header">User ID</th>
                                <th class="table-header">Activity</th>
                                <th class="table-header">Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr>
                                <td colspan="4" class="text-center p-8 text-slate-400 italic">No logs found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal Backdrop -->
    <div id="modalBackdrop" class="modal-backdrop"></div>

    <!-- Modal: New Booking -->
    <div id="bookingModal" class="modal w-full max-w-md bg-white rounded-xl shadow-2xl">
        <div class="flex justify-between items-center p-6 border-b border-slate-100">
            <h2 class="text-xl font-bold text-slate-800">New Booking</h2>
            <button id="closeBookingModalBtn" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        <form id="bookingForm" class="p-6 space-y-4">
            <div>
                <label for="bookingResource" class="form-label">Resource</label>
                <select id="bookingResource" class="form-input" required>
                    <!-- Options generated by JS -->
                </select>
            </div>
            <div>
                <label for="bookingDate" class="form-label">Date</label>
                <input type="date" id="bookingDate" class="form-input" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="bookingStartTime" class="form-label">Start Time</label>
                    <input type="time" id="bookingStartTime" class="form-input" step="3600" required>
                </div>
                <div>
                    <label for="bookingEndTime" class="form-label">End Time</label>
                    <input type="time" id="bookingEndTime" class="form-input" step="3600" required>
                </div>
            </div>
            <div class="flex justify-end pt-6 space-x-3">
                <button type="button" id="cancelBookingModalBtn" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Confirm Booking</button>
            </div>
        </form>
    </div>

    <!-- Custom Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 bg-slate-900 text-white py-3 px-6 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 ease-out z-50">
        <span id="toastMessage"></span>
    </div>

    <script>
        // --- CONFIGURATION ---
        const RESOURCES = [
            { id: 'PC-1', name: 'Computer 1', group: 'PC' },
            { id: 'PC-2', name: 'Computer 2', group: 'PC' },
            { id: 'PC-3', name: 'Computer 3', group: 'PC' },
            { id: 'PC-4', name: 'Computer 4', group: 'PC' },
            { id: 'PC-5', name: 'Computer 5', group: 'PC' },
            { id: 'PC-6', name: 'Computer 6', group: 'PC' },
            { id: 'Laptop-1', name: 'Laptop 1', group: 'Laptop' },
            { id: 'Laptop-2', name: 'Laptop 2', group: 'Laptop' },
            { id: 'Laptop-3', name: 'Laptop 3', group: 'Laptop' },
            { id: 'Laptop-4', name: 'Laptop 4', group: 'Laptop' }
        ];

        // --- GLOBAL STATE ---
        let userId; 
        let currentBookingDate = new Date();
        let allBookings = [];
        let allLogs = [];
        const LOCAL_STORAGE_KEY = 'resource_booking_data_v2';
        
        // --- TAILWIND STYLES ---
        const tableHeaderStyles = "p-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider";
        const tableCellStyles = "p-4 border-b border-slate-100 text-sm";
        const formLabelStyles = "block text-sm font-semibold text-slate-700 mb-1.5";
        const formInputStyles = "block w-full px-3 py-2.5 border border-slate-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition duration-200";
        const btnPrimaryStyles = "bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-5 rounded-lg shadow-sm transition duration-200";
        const btnSecondaryStyles = "bg-white hover:bg-slate-50 text-slate-600 font-bold py-2.5 px-5 rounded-lg border border-slate-200 shadow-sm transition duration-200";
        
        const navLinkBase = "nav-link flex items-center py-3.5 px-6 text-sm font-semibold border-l-4 transition duration-200";
        const activeNavStyles = "bg-indigo-50 text-indigo-600 border-indigo-500 active-nav";
        const inactiveNavStyles = "text-slate-500 hover:bg-slate-50 hover:text-slate-800 border-transparent";
        
        // --- AUTH ---
        function getLocalUserId() {
            let id = localStorage.getItem('booking_user_id');
            if (!id) {
                id = 'user-' + Math.random().toString(36).substring(2, 10);
                localStorage.setItem('booking_user_id', id);
            }
            userId = id;
            document.getElementById('userIdDisplay').textContent = userId;
        }

        // --- PERSISTENCE ---
        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                const data = JSON.parse(storedData);
                allBookings = data.bookings || [];
                allLogs = data.logs || [];
            }
        }

        function saveData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ bookings: allBookings, logs: allLogs }));
        }
        
        function reloadDataAndRender() {
            loadData();
            allBookings.sort((a, b) => a.startTime - b.startTime);
            allLogs.sort((a, b) => b.timestamp - a.timestamp);
            renderLogsTable();
            renderBookingSchedule();
            renderDashboardStats();
            applyTailwindStyles(); 
        }

        // --- HELPERS ---
        function applyTailwindStyles() {
            document.querySelectorAll('.table-header').forEach(el => el.className = tableHeaderStyles);
            document.querySelectorAll('.form-label').forEach(el => el.className = formLabelStyles);
            document.querySelectorAll('.form-input').forEach(el => el.className = formInputStyles);
            document.querySelectorAll('.btn-primary').forEach(el => el.className = btnPrimaryStyles);
            document.querySelectorAll('.btn-secondary').forEach(el => el.className = btnSecondaryStyles);
            
            document.querySelectorAll('.nav-link').forEach(el => {
                const isActive = el.classList.contains('active-nav');
                el.className = `${navLinkBase} ${isActive ? activeNavStyles : inactiveNavStyles}`;
            });
        }

        function formatTimestamp(ts) {
            const date = new Date(ts);
            return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
        }
        
        function formatDateForBooking(date) {
            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        }
        
        function formatDateForInput(date) { return date.toISOString().split('T')[0]; }
        
        function formatTimeForInput(date) {
            return date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-10 right-10 ${isError ? 'bg-red-600' : 'bg-slate-900'} text-white py-3 px-6 rounded-lg shadow-xl transform transition-transform duration-300 ease-out z-50`;
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.getElementById('modalBackdrop').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal.active').forEach(modal => modal.classList.remove('active'));
            document.getElementById('modalBackdrop').classList.remove('active');
        }

        function createLogEntry(activityType, details = "") {
            allLogs.unshift({ id: 'log-' + Date.now(), timestamp: Date.now(), userId: userId, activityType: activityType, details: details });
            saveData();
            renderLogsTable();
            renderDashboardStats();
        }
        
        // --- NAVIGATION ---
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPageId = link.getAttribute('data-page');
                    navLinks.forEach(nl => nl.classList.remove('active-nav'));
                    link.classList.add('active-nav');
                    pages.forEach(p => {
                        if (p.id === `page-${targetPageId}`) p.classList.add('active');
                        else p.classList.remove('active');
                    });
                    applyTailwindStyles();
                    window.location.hash = targetPageId;
                });
            });

            const initialHash = window.location.hash.substring(1) || 'dashboard';
            const initialLink = document.querySelector(`.nav-link[data-page="${initialHash}"]`);
            if (initialLink) initialLink.click();
        }
        
        // --- RENDERING ---
        function renderLogsTable() {
            const tbody = document.getElementById('logsTableBody');
            if (allLogs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-slate-400 italic">No activity recorded yet.</td></tr>`;
                return;
            }
            tbody.innerHTML = allLogs.map(log => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4 border-b border-slate-100 text-sm">${formatTimestamp(log.timestamp)}</td>
                    <td class="p-4 border-b border-slate-100 text-sm font-mono text-xs text-indigo-600">${log.userId}</td>
                    <td class="p-4 border-b border-slate-100 text-sm font-semibold">${log.activityType}</td>
                    <td class="p-4 border-b border-slate-100 text-sm text-slate-500">${log.details || '-'}</td>
                </tr>
            `).join('');
        }
        
        function renderDashboardStats() {
            const now = new Date();
            const pcGrid = document.getElementById('pc-stats-grid');
            const laptopGrid = document.getElementById('laptop-stats-grid');
            pcGrid.innerHTML = ''; laptopGrid.innerHTML = '';

            RESOURCES.forEach(res => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-200";
                
                const bookings = allBookings.filter(b => b.resourceId === res.id);
                const current = bookings.find(b => now.getTime() >= b.startTime && now.getTime() < b.endTime);
                
                let statusText, statusClass, nextText;
                if (current) {
                    statusText = "Occupied";
                    statusClass = "text-red-600";
                    nextText = `Until ${new Date(current.endTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
                } else {
                    statusText = "Available";
                    statusClass = "text-green-600";
                    const next = bookings.filter(b => b.startTime > now.getTime()).sort((a,b)=>a.startTime-b.startTime)[0];
                    nextText = next ? `Next: ${new Date(next.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : "Free for today";
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-slate-800">${res.name}</h3>
                        <span class="text-xl">${res.group === 'PC' ? 'üñ•Ô∏è' : 'üíª'}</span>
                    </div>
                    <p class="text-xl font-bold ${statusClass}">${statusText}</p>
                    <p class="text-xs text-slate-500 mt-1">${nextText}</p>
                `;
                
                if (res.group === 'PC') pcGrid.appendChild(card);
                else laptopGrid.appendChild(card);
            });

            const activityList = document.getElementById('recent-activity-list');
            if (allLogs.length === 0) {
                activityList.innerHTML = `<li class="text-center text-slate-400 py-4 italic">No recent activity.</li>`;
                return;
            }
            activityList.innerHTML = allLogs.slice(0, 5).map(log => `
                <li class="flex items-center space-x-4 p-3 hover:bg-slate-50 rounded-lg transition">
                    <div class="p-2.5 bg-indigo-50 text-indigo-600 rounded-lg text-lg">üìÖ</div>
                    <div>
                        <p class="text-sm font-bold text-slate-800">${log.activityType}</p>
                        <p class="text-xs text-slate-500">${formatTimestamp(log.timestamp)}</p>
                    </div>
                </li>
            `).join('');
        }
        
        function renderBookingSchedule() {
            document.getElementById('bookingDateDisplay').textContent = formatDateForBooking(currentBookingDate);
            const container = document.getElementById('schedules-container');
            container.innerHTML = '';
            
            const dayStartMs = new Date(currentBookingDate).setHours(8, 0, 0, 0);
            const dayEndMs = new Date(currentBookingDate).setHours(18, 0, 0, 0);
            const dayBookings = allBookings.filter(b => b.startTime >= dayStartMs && b.startTime < dayEndMs);

            RESOURCES.forEach(res => {
                const resBox = document.createElement('div');
                resBox.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden";
                resBox.innerHTML = `
                    <div class="bg-indigo-50 p-4 border-b border-indigo-100">
                        <h3 class="font-bold text-indigo-900 flex items-center">
                            <span class="mr-2">${res.group === 'PC' ? 'üñ•Ô∏è' : 'üíª'}</span> ${res.name}
                        </h3>
                    </div>
                    <div id="schedule-${res.id}" class="p-4 space-y-3"></div>
                `;
                container.appendChild(resBox);
                
                const resSchedule = resBox.querySelector(`#schedule-${res.id}`);
                const filteredBookings = dayBookings.filter(b => b.resourceId === res.id);

                for (let hour = 8; hour < 18; hour++) {
                    const slot = document.createElement('div');
                    const timeStart = new Date(currentBookingDate); timeStart.setHours(hour, 0, 0, 0);
                    const timeLabel = timeStart.toLocaleTimeString([], { hour: 'numeric', hour12: true });
                    const b = filteredBookings.find(x => new Date(x.startTime).getHours() === hour);
                    
                    if (b) {
                        slot.className = "p-3 bg-red-50 border border-red-100 rounded-lg flex justify-between items-center";
                        slot.innerHTML = `
                            <div><p class="font-bold text-red-900 text-sm">${timeLabel}</p><p class="text-[10px] text-red-700">Reserved: ${b.bookerId.substring(0, 6)}</p></div>
                            <button class="btn-delete-booking text-[10px] font-bold text-red-600 bg-white px-2 py-1 rounded border border-red-200 hover:bg-red-50" data-id="${b.id}">Cancel</button>
                        `;
                    } else {
                        slot.className = "p-3 bg-white border border-slate-100 rounded-lg flex justify-between items-center hover:border-indigo-200 transition group";
                        slot.innerHTML = `
                            <p class="font-bold text-slate-600 text-sm">${timeLabel}</p>
                            <button class="btn-book-slot bg-slate-50 text-indigo-600 border border-slate-200 px-3 py-1 rounded text-[10px] font-bold group-hover:bg-indigo-600 group-hover:text-white" data-resource="${res.id}" data-time="${hour}">Book</button>
                        `;
                    }
                    resSchedule.appendChild(slot);
                }
            });
            // We no longer call attachBookingScheduleListeners() here because we use delegation
        }

        // --- DELEGATED ACTIONS ---
        function setupDelegatedListeners() {
            const container = document.getElementById('schedules-container');
            
            container.addEventListener('click', (e) => {
                // Find closest button in case user clicked child icon or text
                const target = e.target.closest('button');
                if (!target) return;

                // Handle Booking Click
                if (target.classList.contains('btn-book-slot')) {
                    const resId = target.dataset.resource;
                    const hr = parseInt(target.dataset.time);
                    const start = new Date(currentBookingDate); start.setHours(hr, 0, 0, 0);
                    const end = new Date(currentBookingDate); end.setHours(hr + 1, 0, 0, 0);
                    
                    document.getElementById('bookingResource').value = resId;
                    document.getElementById('bookingDate').value = formatDateForInput(start);
                    document.getElementById('bookingStartTime').value = formatTimeForInput(start);
                    document.getElementById('bookingEndTime').value = formatTimeForInput(end);
                    openModal('bookingModal');
                }

                // Handle Cancel Click
                if (target.classList.contains('btn-delete-booking')) {
                    const id = target.dataset.id;
                    const booking = allBookings.find(x => x.id === id);
                    
                    if (booking && confirm(`Cancel booking for ${booking.resourceId} at ${new Date(booking.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}?`)) {
                        allBookings = allBookings.filter(x => x.id !== id);
                        saveData();
                        createLogEntry(`Cancelled Booking`, `${booking.resourceId} at ${formatTimestamp(booking.startTime)}`);
                        showToast("Booking cancelled.");
                        reloadDataAndRender();
                    }
                }
            });
        }

        function setupEventListeners() {
            // Setup Resource Select
            const select = document.getElementById('bookingResource');
            RESOURCES.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id; opt.textContent = r.name;
                select.appendChild(opt);
            });

            // Modal Controls
            document.getElementById('closeBookingModalBtn').onclick = closeModal;
            document.getElementById('cancelBookingModalBtn').onclick = closeModal;
            document.getElementById('modalBackdrop').onclick = closeModal;
            
            document.getElementById('openBookingModalBtn').onclick = () => {
                document.getElementById('bookingForm').reset();
                document.getElementById('bookingDate').value = formatDateForInput(currentBookingDate);
                openModal('bookingModal');
            };

            // Booking Form Submit
            document.getElementById('bookingForm').onsubmit = (e) => {
                e.preventDefault();
                const resId = document.getElementById('bookingResource').value;
                const d = document.getElementById('bookingDate').value;
                const sStr = document.getElementById('bookingStartTime').value;
                const eStr = document.getElementById('bookingEndTime').value;
                
                const start = new Date(d + 'T' + sStr);
                const end = new Date(d + 'T' + eStr);
                
                if (end <= start) return showToast("End time must be after start time.", true);
                
                // Conflict Check
                const hasConflict = allBookings.find(b => b.resourceId === resId && (start.getTime() < b.endTime && end.getTime() > b.startTime));
                if (hasConflict) return showToast("This time slot is already reserved.", true);

                allBookings.push({ 
                    id: 'book-' + Date.now(), 
                    resourceId: resId, 
                    startTime: start.getTime(), 
                    endTime: end.getTime(), 
                    bookerId: userId 
                });
                
                saveData();
                createLogEntry(`New Booking`, `${resId} for ${formatTimestamp(start.getTime())}`);
                showToast("Booking confirmed!");
                closeModal();
                reloadDataAndRender();
            };

            // Day Navigation
            document.getElementById('prevDayBtn').onclick = () => { 
                currentBookingDate.setDate(currentBookingDate.getDate() - 1); 
                reloadDataAndRender(); 
            };
            document.getElementById('nextDayBtn').onclick = () => { 
                currentBookingDate.setDate(currentBookingDate.getDate() + 1); 
                reloadDataAndRender(); 
            };
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            getLocalUserId();
            setupNavigation();
            setupEventListeners();
            setupDelegatedListeners(); // Setup the delegate once
            reloadDataAndRender(); 
        });
    </script>
</body>
</html>